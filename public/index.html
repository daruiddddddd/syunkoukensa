<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>竣工検査ツール</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f0f0f0; }
    canvas { border: 1px solid #ccc; background: #fff; touch-action: none; width: 100%; max-width: 1000px; height: 600px; }
    #tabs button { margin-right: 5px; padding: 6px 10px; }
    #popup { position: absolute; background: white; border: 1px solid #ccc; padding: 10px; display: none; z-index: 10; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 14px; }
  </style>
</head>
<body>
  <h1>竣工検査ツール</h1>
  <div id="tabs">
    <button onclick="switchTab('1階')">1階</button>
    <button onclick="switchTab('2階')">2階</button>
    <button onclick="switchTab('3階')">3階</button>
    <button onclick="switchTab('4階')">4階</button>
    <button onclick="switchTab('まとめ')">まとめ</button>
  </div>
  <div id="toolbar">
    <button onclick="toggleDrawMode()">✏️ 注釈モード</button>
    <input type="file" accept="image/*" onchange="loadImage(event)">
    <button onclick="exportCSV()">CSV出力</button>
  </div>
  <canvas id="canvas" width="1000" height="600"></canvas>
  <div id="popup">
    <select id="category">
      <option>天井</option>
      <option>壁</option>
      <option>床</option>
      <option>電気</option>
      <option>設備</option>
    </select><br>
    <input type="text" id="note" placeholder="内容"><br>
    <button onclick="confirmNote()">OK</button>
  </div>
  <div id="summary"></div>
  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawMode = false, drawing = false;
    let startX, startY;
    let floor = '1階';
    let counter = { '1階': 1, '2階': 1, '3階': 1, '4階': 1 };
    let annotations = { '1階': [], '2階': [], '3階': [], '4階': [] };
    let currentLine = null;
    const ip = "192.168.0.77"; // 仮のIP
    const ipColor = { [ip]: "#e91e63" };

    function switchTab(f) {
      floor = f;
      document.getElementById('summary').style.display = (f === 'まとめ') ? 'block' : 'none';
      canvas.style.display = (f === 'まとめ') ? 'none' : 'block';
      if (f === 'まとめ') showSummary();
    }

    function toggleDrawMode() {
      drawMode = !drawMode;
    }

    function loadImage(e) {
      const reader = new FileReader();
      reader.onload = function(evt) {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        img.src = evt.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    }

    canvas.addEventListener('mousedown', e => {
      if (!drawMode) return;
      const rect = canvas.getBoundingClientRect();
      startX = e.clientX - rect.left;
      startY = e.clientY - rect.top;
      drawing = true;
    });

    canvas.addEventListener('mousemove', e => {
      if (!drawing || !drawMode) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      loadImage.last && ctx.drawImage(loadImage.last, 0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      ctx.moveTo(startX, startY);
      ctx.lineTo(x, y);
      ctx.strokeStyle = ipColor[ip];
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.fillStyle = ipColor[ip];
      ctx.font = "18px sans-serif";
      ctx.fillText(`\u2460`.charCodeAt(0) + counter[floor] - 1, x + 8, y - 8);
    });

    canvas.addEventListener('mouseup', e => {
      if (!drawing || !drawMode) return;
      drawing = false;
      const rect = canvas.getBoundingClientRect();
      const endX = e.clientX - rect.left;
      const endY = e.clientY - rect.top;
      currentLine = { x1: startX, y1: startY, x2: endX, y2: endY };
      const popup = document.getElementById('popup');
      popup.style.left = `${e.pageX}px`;
      popup.style.top = `${e.pageY}px`;
      popup.style.display = 'block';
    });

    function confirmNote() {
      const cat = document.getElementById('category').value;
      const note = document.getElementById('note').value;
      const n = counter[floor]++;
      annotations[floor].push({ ...currentLine, num: n, cat, note, ip });
      drawAnnotation(currentLine, n, cat, note);
      document.getElementById('popup').style.display = 'none';
    }

    function drawAnnotation(a, n, cat, note) {
      ctx.beginPath();
      ctx.moveTo(a.x1, a.y1);
      ctx.lineTo(a.x2, a.y2);
      ctx.strokeStyle = ipColor[ip];
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.fillStyle = ipColor[ip];
      ctx.font = "18px sans-serif";
      ctx.fillText(`\u2460`.charCodeAt(0) + n - 1, a.x2 + 6, a.y2 - 6);
    }

    function showSummary() {
      const div = document.getElementById('summary');
      div.innerHTML = '<h3>注釈一覧</h3>';
      let html = '<table><tr><th>階</th><th>番号</th><th>カテゴリ</th><th>内容</th><th>IP</th></tr>';
      for (let fl in annotations) {
        for (let a of annotations[fl]) {
          const num = String.fromCharCode(9311 + a.num); // 丸数字
          html += `<tr style="color:${ipColor[a.ip]}"><td>${fl}</td><td>${num}</td><td>${a.cat}</td><td>${a.note}</td><td>${a.ip}</td></tr>`;
        }
      }
      html += '</table><button onclick="downloadCSV()">CSV保存</button>';
      div.innerHTML += html;
    }

    function exportCSV() {
      if (floor === 'まとめ') return downloadCSV();
      let csv = "階,番号,カテゴリ,内容,IP\n";
      for (let a of annotations[floor]) {
        const num = String.fromCharCode(9311 + a.num);
        csv += `${floor},${num},${a.cat},${a.note},${a.ip}\n`;
      }
      download(csv, `注釈_${floor}.csv`);
    }

    function downloadCSV() {
      let csv = "階,番号,カテゴリ,内容,IP\n";
      for (let fl in annotations) {
        for (let a of annotations[fl]) {
          const num = String.fromCharCode(9311 + a.num);
          csv += `${fl},${num},${a.cat},${a.note},${a.ip}\n`;
        }
      }
      download(csv, "注釈まとめ.csv");
    }

    function download(text, name) {
      const blob = new Blob([text], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = name;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
