<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>竣工検査ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f8f8f8; }
    h1 { margin-bottom: 10px; }
    #tabs button.active { background: #1e40af; color: white; }
    #tabs button { margin-right: 5px; padding: 6px 12px; }
    #toolbar button, input[type=file] {
      margin-right: 8px;
      margin-top: 10px;
    }
    canvas {
      border: 1px solid #ccc;
      background: #fff;
      width: 100%;
      max-width: 1000px;
      height: 600px;
      touch-action: none;
    }
    #popup {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      display: none;
      z-index: 10;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 14px;
    }
    #summary { display: none; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>竣工検査ツール - 完成版</h1>
  <div id="tabs">
    <button onclick="switchTab('1階')">1階</button>
    <button onclick="switchTab('2階')">2階</button>
    <button onclick="switchTab('3階')">3階</button>
    <button onclick="switchTab('4階')">4階</button>
    <button onclick="switchTab('まとめ')">まとめ</button>
  </div>

  <div id="toolbar">
    <button onclick="toggleDrawMode()">✏️ 注釈モード</button>
    <button onclick="undo()">1個前消去</button>
    <input type="file" accept="image/*" onchange="handleImageUpload(event)">
    <button onclick="saveCSV()">CSV保存</button>
    <button onclick="saveImage()">画像保存</button>
  </div>

  <canvas id="canvas" width="1000" height="600"></canvas>

  <div id="popup">
    <label>カテゴリ:
      <select id="category">
        <option>天井</option>
        <option>壁</option>
        <option>床</option>
        <option>電気</option>
        <option>設備</option>
      </select>
    </label><br>
    <label>内容:
      <input type="text" id="note" />
    </label><br>
    <button onclick="confirmNote()">OK</button>
  </div>

  <div id="summary"></div>

  <script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let floor = '1階';
  let drawMode = false;
  let annotations = { '1階': [], '2階': [], '3階': [], '4階': [] };
  let counters = { '1階': 1, '2階': 1, '3階': 1, '4階': 1 };
  let startX, startY, tempLine = null;
  let ip = '192.168.0.77';
  let ipColors = {};
  ipColors[ip] = '#e91e63';

  function switchTab(f) {
    floor = f;
    document.getElementById('summary').style.display = f === 'まとめ' ? 'block' : 'none';
    canvas.style.display = f === 'まとめ' ? 'none' : 'block';
    if (f === 'まとめ') renderSummary();
    else redraw();
  }

  function toggleDrawMode() {
    drawMode = !drawMode;
  }

  function handleImageUpload(e) {
    const reader = new FileReader();
    reader.onload = function(evt) {
      const img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      };
      img.src = evt.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
  }

  canvas.addEventListener('mousedown', (e) => {
    if (!drawMode) return;
    const rect = canvas.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    tempLine = { x1: startX, y1: startY };
  });

  canvas.addEventListener('mousemove', (e) => {
    if (!drawMode || !tempLine) return;
    const rect = canvas.getBoundingClientRect();
    const x2 = e.clientX - rect.left;
    const y2 = e.clientY - rect.top;
    redraw();
    drawArrow(tempLine.x1, tempLine.y1, x2, y2, getColor(ip), getCircleNum(counters[floor]), true);
  });

  canvas.addEventListener('mouseup', (e) => {
    if (!drawMode || !tempLine) return;
    const rect = canvas.getBoundingClientRect();
    const x2 = e.clientX - rect.left;
    const y2 = e.clientY - rect.top;
    tempLine.x2 = x2;
    tempLine.y2 = y2;
    const popup = document.getElementById('popup');
    popup.style.left = e.pageX + 'px';
    popup.style.top = e.pageY + 'px';
    popup.style.display = 'block';
  });

  function confirmNote() {
    const cat = document.getElementById('category').value;
    const note = document.getElementById('note').value;
    const num = counters[floor]++;
    const entry = { ...tempLine, num, cat, note, ip };
    annotations[floor].push(entry);
    tempLine = null;
    document.getElementById('popup').style.display = 'none';
    redraw();
  }

  function getCircleNum(n) {
    const base = 9311; // ①のUnicode
    return String.fromCharCode(base + (n - 1));
  }

  function getColor(ip) {
    if (!ipColors[ip]) {
      const color = '#' + Math.floor(Math.random()*16777215).toString(16);
      ipColors[ip] = color;
    }
    return ipColors[ip];
  }

  function drawArrow(x1, y1, x2, y2, color, label, preview = false) {
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.stroke();
    const offsetX = (x2 - x1) * 0.05;
    const offsetY = (y2 - y1) * 0.05;
    ctx.fillStyle = color;
    ctx.font = "18px sans-serif";
    ctx.fillText(label, x2 + offsetX + 4, y2 + offsetY - 4);
  }

  function redraw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (const a of annotations[floor]) {
      drawArrow(a.x1, a.y1, a.x2, a.y2, getColor(a.ip), getCircleNum(a.num));
    }
  }
  function renderSummary() {
    const div = document.getElementById('summary');
    let html = '<h2>全階注釈一覧</h2><table><thead><tr><th>階</th><th>番号</th><th>カテゴリ</th><th>内容</th><th>IP</th></tr></thead><tbody>';
    for (const fl in annotations) {
      for (const a of annotations[fl]) {
        html += `<tr style="color:${getColor(a.ip)}"><td>${fl}</td><td>${getCircleNum(a.num)}</td><td>${a.cat}</td><td>${a.note}</td><td>${a.ip}</td></tr>`;
      }
    }
    html += '</tbody></table><button onclick="downloadCSV()">CSV保存</button>';
    div.innerHTML = html;
  }

  function downloadCSV() {
    let csv = "階,番号,カテゴリ,内容,IP\\n";
    for (const fl in annotations) {
      for (const a of annotations[fl]) {
        csv += `${fl},${getCircleNum(a.num)},${a.cat},${a.note},${a.ip}\\n`;
      }
    }
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "注釈まとめ.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  function saveCSV() {
    if (floor === 'まとめ') {
      downloadCSV();
      return;
    }
    let csv = "階,番号,カテゴリ,内容,IP\\n";
    for (const a of annotations[floor]) {
      csv += `${floor},${getCircleNum(a.num)},${a.cat},${a.note},${a.ip}\\n`;
    }
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `注釈_${floor}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function saveImage() {
    const link = document.createElement('a');
    link.download = `注釈_${floor}.jpeg`;
    link.href = canvas.toDataURL('image/jpeg', 0.9);
    link.click();
  }

  function undo() {
    const list = annotations[floor];
    const lastIndex = list.map(a => a.ip).lastIndexOf(ip);
    if (lastIndex >= 0) {
      list.splice(lastIndex, 1);
      redraw();
    }
  }
</script>
</body>
</html>
